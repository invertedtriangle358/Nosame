<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>縦書きミニNostrクライアント</title>
  <style>
    :root {
      --bg: #0b0b0c;
      --panel: #141418;
      --muted: #8a8fa3;
      --text: #f2f4f8;
      --accent: #5bb0ff;
      --ok: #3ecf8e;
      --warn: #ffaf38;
      --err: #ff5c5c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      display: grid; grid-template-rows: auto 1fr auto; height: 100vh;
    }
    header {
      padding: 12px; display: grid; gap: 8px; background: var(--panel);
      grid-template-columns: 1fr 1fr auto auto auto; align-items: center;
      border-bottom: 1px solid #23242a;
    }
    header input, header button, header select {
      background: #0f1013; color: var(--text); border: 1px solid #2a2c33; border-radius: 10px; padding: 10px 12px; font-size: 14px;
    }
    header button { cursor: pointer; }
    header button.primary { background: var(--accent); color: #001627; border-color: #2c7ee6; font-weight: 600; }
    header button.ghost { background: transparent; border-color: #2a2c33; }
    header .status { font-size: 12px; color: var(--muted); }

    main {
      display: grid; grid-template-columns: 280px 1fr; gap: 0; height: 100%;
    }
    .sidebar {
      border-right: 1px solid #23242a; padding: 12px; background: #0e0f12; display: grid; grid-auto-rows: min-content; gap: 10px;
    }
    .sidebar h2 { margin: 6px 0 4px; font-size: 14px; color: var(--muted); font-weight: 600; }
    .sidebar .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
    .sidebar input, .sidebar button, .sidebar select, textarea {
      background: #0f1013; color: var(--text); border: 1px solid #2a2c33; border-radius: 10px; padding: 10px 12px; font-size: 14px;
    }
    .sidebar small { color: var(--muted); }

    .composer { display: grid; gap: 6px; }
    .composer textarea { width: 100%; min-height: 120px; resize: vertical; }
    .composer .row { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
    .composer .hint { color: var(--muted); font-size: 12px; }

    .timeline-wrap {
      position: relative; overflow: auto; background: radial-gradient(1200px 80% at 95% 50%, rgba(65,72,90,0.15), transparent 60%);
      display: grid;
    }

    /* 縦書き領域 */
    .vertical-timeline {
      padding: 20px; display: flex; align-items: flex-start; gap: 16px; height: 100%;
      writing-mode: vertical-rl; text-orientation: mixed; /* 日本語は縦、中の英数は横 */
      overflow: auto;
    }

    .note {
      background: var(--panel); border: 1px solid #242733; border-radius: 18px; padding: 14px; line-height: 1.8; min-height: 260px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      display: inline-flex; flex-direction: column; gap: 8px;
    }
    .note .meta { color: var(--muted); font-size: 12px; }
    .note .author { color: var(--accent); font-weight: 600; }
    .note .content { font-size: 16px; }

    .empty {
      color: var(--muted); display: grid; place-items: center; font-size: 14px;
    }

    footer { padding: 8px 12px; color: var(--muted); font-size: 12px; border-top: 1px solid #23242a; background: #0e0f12; display: flex; justify-content: space-between; }
    a { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <header>
    <input id="relay" placeholder="Relay: wss://relay.example (複数はカンマ)" value="wss://relay.damus.io,wss://nos.lol" />
    <input id="author" placeholder="著者pubkey(HEX, 任意)" />
    <select id="kind">
      <option value="1" selected>kind:1（テキスト）</option>
      <option value="6">kind:6（Repost）</option>
    </select>
    <button id="btnConnect" class="ghost">接続</button>
    <div class="status" id="status">未接続</div>
  </header>

  <main>
    <aside class="sidebar">
      <h2>購読</h2>
      <div class="row">
        <input id="limit" type="number" min="1" max="200" value="50" />
        <button id="btnSubscribe">購読/更新</button>
      </div>
      <small>author空→全体。authorにHEXを入れるとその著者の投稿のみ。</small>

      <h2>投稿（NIP-07拡張が必要）</h2>
      <div class="composer">
        <div class="row">
          <button id="btnMe" class="ghost">私のpubkey取得</button>
          <small class="hint">ブラウザ拡張（例: nos2x、Alby等）が必要</small>
        </div>
        <textarea id="compose" placeholder="縦書きで表示されます。ここに本文…"></textarea>
        <div class="row">
          <button id="btnPublish" class="primary">投稿</button>
          <small class="hint" id="postHint"></small>
        </div>
      </div>
    </aside>

    <section class="timeline-wrap">
      <div id="timeline" class="vertical-timeline empty">購読するとここに縦書きでノートが並びます</div>
    </section>
  </main>

  <footer>
    <div>縦書きミニNostrクライアント / NIP-01 & NIP-07（任意）</div>
    <div>MITライセンス・自己責任でご利用ください</div>
  </footer>

  <script>
    // ---- 簡易ユーティリティ ----
    const qs = (s) => document.querySelector(s);
    const qsa = (s) => Array.from(document.querySelectorAll(s));

    const enc = (obj) => new TextEncoder().encode(JSON.stringify(obj));
    const sha256 = async (bytes) => {
      const buf = await crypto.subtle.digest('SHA-256', bytes);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
    };

    // ---- Nostr 基本 ----
    let sockets = [];
    let subId = 'sub-' + Math.random().toString(36).slice(2, 8);

    function connectRelays(relayList) {
      // 既存切断
      sockets.forEach(ws => { try { ws.close(); } catch(e){} });
      sockets = [];
      const relays = relayList.split(',').map(s => s.trim()).filter(Boolean);
      const status = qs('#status');
      status.textContent = '接続中…';
      let openCount = 0;
      relays.forEach(url => {
        const ws = new WebSocket(url);
        ws.onopen = () => { openCount++; status.textContent = `接続: ${openCount}/${relays.length}`; };
        ws.onclose = () => { status.textContent = `切断: ${url}`; };
        ws.onerror = () => { status.textContent = `エラー: ${url}`; };
        ws.onmessage = onMessage;
        sockets.push(ws);
      });
    }

    function subscribe() {
      const kind = Number(qs('#kind').value);
      const author = qs('#author').value.trim();
      const limit = Number(qs('#limit').value) || 50;
      const filter = { kinds: [kind], limit };
      if (author) filter.authors = [author]; // HEXのみ対応（簡素化）

      // 表示リセット
      const tl = qs('#timeline');
      tl.innerHTML = ''; tl.classList.remove('empty');

      const req = ["REQ", subId, filter];
      sockets.forEach(ws => { if (ws.readyState === 1) ws.send(JSON.stringify(req)); });
    }

    function onMessage(ev) {
      try {
        const msg = JSON.parse(ev.data);
        if (msg[0] === 'EVENT' && msg[1] === subId) {
          const event = msg[2];
          renderEvent(event);
        }
        if (msg[0] === 'EOSE' && msg[1] === subId) {
          // 受信完了の合図
        }
      } catch (e) { /* noop */ }
    }

    function renderEvent(ev) {
      // kind 1/6のみ簡易対応
      let content = ev.content || '';
      if (ev.kind === 6) {
        // Repostの中身（JSONのEVENTを試みて展開）
        try { const inner = JSON.parse(content); if (inner && inner.content) content = `RP › ${inner.content}`; } catch(e){}
      }

      const el = document.createElement('article');
      el.className = 'note';
      const ts = new Date(ev.created_at * 1000).toLocaleString();
      el.innerHTML = `
        <div class="meta">${ts}</div>
        <div class="author">${ev.pubkey.slice(0, 8)}…</div>
        <div class="content"></div>
      `;
      el.querySelector('.content').textContent = content;

      // 先頭に並べる（縦書きなので右側に来る）
      const tl = qs('#timeline');
      tl.prepend(el);
    }

    // ---- 投稿（NIP-07） ----
    async function publish() {
      const ext = window.nostr;
      const hint = qs('#postHint');
      if (!ext) { hint.textContent = 'NIP-07対応拡張が見つかりません'; return; }
      const content = qs('#compose').value.trim();
      if (!content) { hint.textContent = '本文が空です'; return; }
      try {
        const pubkey = await ext.getPublicKey();
        const created_at = Math.floor(Date.now() / 1000);
        const tags = [];
        const kind = 1;
        const unsigned = { kind, created_at, tags, content, pubkey };
        const id = await sha256(enc([0, pubkey, created_at, kind, tags, content]));
        const ev = await ext.signEvent({ ...unsigned, id });
        // 各リレーにPUB
        let okCount = 0, errCount = 0;
        await Promise.allSettled(sockets.map(ws => new Promise((res) => {
          if (ws.readyState !== 1) return res();
          const sub = 'ack-' + Math.random().toString(36).slice(2,6);
          ws.addEventListener('message', function onAck(e){
            try { const m = JSON.parse(e.data); if (m[0]==='OK' && m[1]===ev.id) { if (m[2]) okCount++; else errCount++; ws.removeEventListener('message', onAck); res(); } } catch(_){}
          });
          ws.send(JSON.stringify(["EVENT", ev]));
        })));
        hint.textContent = `送信: OK ${okCount} / NG ${errCount}`;
        qs('#compose').value = '';
      } catch (e) {
        hint.textContent = '投稿失敗: ' + (e?.message || e);
      }
    }

    // ---- イベント配線 ----
    qs('#btnConnect').addEventListener('click', () => connectRelays(qs('#relay').value));
    qs('#btnSubscribe').addEventListener('click', subscribe);
    qs('#btnPublish').addEventListener('click', publish);
    qs('#btnMe').addEventListener('click', async () => {
      if (!window.nostr) { alert('NIP-07拡張が必要です'); return; }
      try { const pk = await window.nostr.getPublicKey(); qs('#author').value = pk; } catch(_){}
    });

    // 起動時の簡易接続
    connectRelays(qs('#relay').value);
  </script>
</body>
</html>
